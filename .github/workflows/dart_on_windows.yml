name: Windows CMake (clang-cl)

on: [ push, pull_request ]

env:
  BUILD_DIR_RELEASE: build/windows/x64/runner

defaults:
  run:
    shell: pwsh

jobs:
  build-clang:
    runs-on: windows-2025

    steps:

      # windows is so funny ... NOT
      - name: Enable Git long paths
        run: git config --global core.longpaths true
        shell: pwsh

      - name: Checkout
        uses: actions/checkout@v6.0.0
        with:
            fetch-depth: 0
            submodules: recursive

      # my windows container is quite big ... so remove runner packages for enough
      # dis space
      - name: Cleanup disk space
        uses: ./.github/actions/cleanup-disk-space

      - name: Login to GitHub
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: Kataglyphis
          password: ${{ secrets.GHCR_PAT }}

      - name: Pull image
        run: |
          docker pull ghcr.io/kataglyphis/kataglyphis_beschleuniger:winamd64 

      - name: Run container
        run: |
          # Define the PowerShell script to run INSIDE the container.
          # We have consolidated Flutter setup, Rust build, and CMake build here.
          $script = @'
          $ErrorActionPreference = "Stop"

          Write-Host "=== 1. Environment Check ==="
          cmake --version
          clang-cl --version
          flutter --version
          cargo --version

          # --- FLUTTER & DART SETUP ---
          Write-Host "=== 2. Installing Flutter Dependencies ==="
          # Note: This requires Flutter to be installed in the Docker image
          flutter config --enable-windows-desktop
          flutter pub get

          # --- NEW: CODE QUALITY & TESTS ---
          Write-Host "=== 1. Verifying Formatting (dart format) ==="
          # Use dart format to ensure code styling is consistent
          dart format --output=none --set-exit-if-changed .
          Write-Host "=== 2. Analyzing Project Source (dart analyze) ==="
          # Runs code analysis to check for issues and warnings
          dart analyze --fatal-warnings
          Write-Host "=== 3. Running Flutter Tests ==="
          # Runs all tests in the project
          flutter test

          # --- RUST BUILD ---
          Write-Host "=== 3. Building Rust Crate ==="
          Set-Location "C:\workspace\rust"
          # Installing codegen might be skipped if already in image, but keeping for safety
          cargo install flutter_rust_bridge_codegen
          cargo build --release
          Set-Location "C:\workspace"

          # --- FLUTTER EPHEMERAL BUILD (Header Generation) ---
          Write-Host "=== 4. Generating C++ Bindings (Ephemeral Build) ==="
          # We run a build to generate headers, then delete the build output 
          # so CMake starts with a clean slate, but headers in windows/runner remain.
          try {
              flutter build windows --release
          } catch {
              Write-Warning "Flutter build threw an error, but proceeding if headers were generated."
          }
          if (Test-Path "C:\workspace\build") {
              Write-Host "Cleaning build directory for CMake..."
              Remove-Item -Recurse -Force "C:\workspace\build"
          }

          # --- CMAKE CONFIGURE ---
          Write-Host "=== 5. CMake Configure ==="
          cmake -S "C:\workspace\windows" `
                -B "C:\workspace\build\windows\x64" `
                -G "Ninja" `
                -DCMAKE_BUILD_TYPE=Release `
                -DCMAKE_INSTALL_PREFIX="C:\workspace\build\windows\x64\runner" `
                -DFLUTTER_TARGET_PLATFORM=windows-x64 `
                -DCMAKE_CXX_COMPILER=clang-cl `
                -DCMAKE_C_COMPILER=clang-cl `
                -DCMAKE_CXX_COMPILER_TARGET=x86_64-pc-windows-msvc

          # --- MOVE RUST DLL ---
          Write-Host "=== 6. Copying Rust DLL ==="
          $dllSource = "C:\workspace\rust\target\release\rust_lib_kataglyphis_inference_engine.dll"
          $dllDestDir = "C:\workspace\build\windows\x64\plugins\rust_lib_kataglyphis_inference_engine"
          if (-not (Test-Path $dllSource)) {
             Write-Error "Rust DLL not found at $dllSource"
          }
          New-Item -ItemType Directory -Force -Path $dllDestDir | Out-Null
          Copy-Item -Path $dllSource -Destination $dllDestDir -Force
          Write-Host "Rust DLL copied successfully."

          # --- NATIVE ASSETS FIX ---
          Write-Host "=== 7. Applying Native Assets Dir Fix ==="
          $p = "C:\workspace\build\native_assets\windows"
          if (Test-Path $p) {
              $it = Get-Item -LiteralPath $p -Force
              if (-not $it.PSIsContainer) {
                  Remove-Item -LiteralPath $p -Force
                  New-Item -ItemType Directory -Path $p | Out-Null
              }
          } else {
              New-Item -ItemType Directory -Path $p | Out-Null
          }

          # --- CMAKE BUILD & INSTALL ---
          Write-Host "=== 8. CMake Build & Install ==="
          cmake --build "C:\workspace\build\windows\x64" --config Release --target install --verbose
          '@
          # Encode script for passing to Docker
          $b64 = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($script))
          # Run Docker
          # Mount: ${{ github.workspace }} -> C:\workspace
          docker run --rm `
            --mount "type=bind,source=${{ github.workspace }},target=C:\workspace" `
            -w "C:\workspace" `
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:winamd64 `
            powershell -NoProfile -ExecutionPolicy Bypass -EncodedCommand $b64

      # see also the install commands in the bottom of the CMakeLists.txt
      - name: Upload files & Zip
        uses: actions/upload-artifact@v5.0.0
        with:
          name: windows-files
          path: |
            ${{ env.BUILD_DIR_RELEASE }}/**/*.exe
            ${{ env.BUILD_DIR_RELEASE }}/**/*.dll
            ${{ env.BUILD_DIR_RELEASE }}/data/**/*
