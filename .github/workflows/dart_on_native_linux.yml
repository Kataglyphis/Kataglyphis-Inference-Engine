# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Build + test + run on Linux natively - x86-64/arm64

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

env:
  APP_NAME: kataglyphis-inference-engine
  FLUTTER_VERSION: 3.38.8   # change here to update version for the whole workflow

jobs:
  build:
    strategy:
      matrix:
        include:
          - runs_on: ubuntu-24.04
            arch: x64
            platform: linux/amd64
          - runs_on: ubuntu-24.04-arm
            arch: arm64
            platform: linux/arm64

    runs-on: ${{ matrix.runs_on }}

    steps:
      - name: Free Disk Space on Host
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Prune Docker + show disk usage
        run: |
          set -eux
          docker system prune -af --volumes || true
          docker system df || true
          df -h

      - uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Pull container image
        run: |
          for i in 1 2 3; do
            echo "Attempt $i to pull container..."
            if timeout 900 docker pull ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest; then
              echo "Successfully pulled container"
              docker system df || true
              exit 0
            fi
            echo "Pull failed, waiting before retry..."
            sleep 30
          done
          echo "Failed to pull container after 3 attempts"
          exit 1

      - name: Setup Flutter in container
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e FLUTTER_VERSION=${{ env.FLUTTER_VERSION }} \
            -e MATRIX_ARCH=${{ matrix.arch }} \
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest \
            bash -lc '
            set -e
            git config --global --add safe.directory /workspace || true
            git config --global --add safe.directory /workspace/flutter || true

            if [ "$MATRIX_ARCH" = "x64" ]; then
              chmod +x scripts/linux/setup-flutter-x86-64.sh
              ./scripts/linux/setup-flutter-x86-64.sh $FLUTTER_VERSION
            else
              chmod +x scripts/linux/setup-flutter-arm64.sh
              ./scripts/linux/setup-flutter-arm64.sh $FLUTTER_VERSION
            fi
            chmod -R u+rwX flutter/bin/cache 2>/dev/null || true
            chmod -R u+rwX flutter 2>/dev/null || true 
            '

      - name: Run Flutter checks and tests
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest \
            bash -lc '
            set -e
            export PATH="$PWD/flutter/bin:$PATH"
            git config --global --add safe.directory /workspace || true
            git config --global --add safe.directory /workspace/flutter || true
            flutter pub get
            dart format --output=none --set-exit-if-changed . || true
            dart analyze || true
            flutter test || true
            flutter config --enable-linux-desktop
            '

      - name: Build Flutter Linux app
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e APP_NAME=${{ env.APP_NAME }} \
            -e MATRIX_ARCH=${{ matrix.arch }} \
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest \
            bash -lc '
            set -e
            export PATH="$PWD/flutter/bin:$PATH"
            git config --global --add safe.directory /workspace || true
            git config --global --add safe.directory /workspace/flutter || true

            # Ensure a working C/C++ toolchain for Flutter desktop builds.
            # The ARM64 Linux build can fail with:
            #   /usr/include/glib-2.0/glib/glib-typeof.h: fatal error: \'type_traits\' file not found
            # which indicates missing C++ standard library headers.
            #
            # We want to continue building with Clang, but allow a custom GCC
            # toolchain (e.g. mounted at /opt/gcc-15.2.0) to be discoverable.
            GCC_TOOLCHAIN=""
            if [ -x /opt/gcc-15.2.0/bin/gcc ] && [ -x /opt/gcc-15.2.0/bin/g++ ]; then
              echo "Found custom GCC toolchain at /opt/gcc-15.2.0 (keeping Clang as compiler)"
              export PATH="/opt/gcc-15.2.0/bin:$PATH"
              GCC_TOOLCHAIN="/opt/gcc-15.2.0"
            fi

            if command -v clang >/dev/null 2>&1 && command -v clang++ >/dev/null 2>&1; then
              export CC=clang
              export CXX=clang++
              if [ -n "$GCC_TOOLCHAIN" ]; then
                export CFLAGS="${CFLAGS:-} --gcc-toolchain=$GCC_TOOLCHAIN"
                export CXXFLAGS="${CXXFLAGS:-} --gcc-toolchain=$GCC_TOOLCHAIN"
              fi
            fi

            # Avoid heredocs here because this script runs inside a single-quoted bash string in YAML.
            printf '%s\n' \
              '#include <type_traits>' \
              'int main() { return std::is_integral_v<int> ? 0 : 1; }' \
              > /tmp/_check_type_traits.cpp

            if ! ${CXX:-c++} -std=c++17 /tmp/_check_type_traits.cpp -c -o /tmp/_check_type_traits.o >/dev/null 2>&1; then
              echo "C++ stdlib headers missing; installing build essentials in container..."
              if command -v apt-get >/dev/null 2>&1; then
                apt-get update
                DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                  build-essential \
                  g++ \
                  clang \
                  libc++-dev \
                  libc++abi-dev
              elif command -v apk >/dev/null 2>&1; then
                apk add --no-cache build-base clang libc++ libc++-dev
              else
                echo "No supported package manager found to install C++ headers." >&2
                exit 1
              fi
            fi

            echo "PWD is: $PWD"
            echo "Looking for flutter at: $PWD/flutter/bin/flutter"
            ls -la "$PWD/flutter/bin" || echo "Flutter bin directory not found!"

            # Ensure the flutter wrapper is executable and the cache is writable.
            # Common failure: mounted flutter/ files are owned by another UID and the wrapper tries to update engine.stamp.
            chmod +x "$PWD/flutter/bin/flutter" || true
            mkdir -p "$PWD/flutter/bin/cache" || true
            # make cache writable so Flutter can update engine.stamp; be permissive but safe for CI.
            chmod -R a+rwX "$PWD/flutter/bin/cache" || true

            # Try to fix ownership if possible (no-op if not allowed).
            CURRENT_UID=$(id -u || echo 0)
            CURRENT_GID=$(id -g || echo 0)
            chown -R "$CURRENT_UID:$CURRENT_GID" "$PWD/flutter" 2>/dev/null || true

            # refresh shell command cache
            hash -r || true

            # Verify flutter is callable
            echo "PATH=$PATH"
            command -v flutter || echo "flutter not found via PATH; will call directly via absolute path"
            # First run: show version (this will also populate cache if writable)
            if ! "$PWD/flutter/bin/flutter" --version; then
              echo "Initial flutter run failed â€” trying again after relaxing permissions and invoking via bash"
              chmod -R a+rwX "$PWD/flutter" || true
              chown -R "$CURRENT_UID:$CURRENT_GID" "$PWD/flutter" 2>/dev/null || true
              # invoke via bash in case the filesystem forbids direct exec of the wrapper script
              bash "$PWD/flutter/bin/flutter" --version || true
            fi

            # run the build (use the absolute path to be robust)
            "$PWD/flutter/bin/flutter" build linux --release
           
            '

      - name: Package build artifacts
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            -e APP_NAME=${{ env.APP_NAME }} \
            -e MATRIX_ARCH=${{ matrix.arch }} \
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest \
            bash -lc '
            set -e
            rm -rf build/linux/$MATRIX_ARCH/release/obj || true
            rm -rf ~/.pub-cache/hosted || true
            mkdir -p out
            cp -r build/linux/$MATRIX_ARCH/release/bundle out/${APP_NAME}-bundle
            tar -C out -czf ${APP_NAME}-linux-$MATRIX_ARCH.tar.gz ${APP_NAME}-bundle
            '

      - name: Generate documentation
        if: ${{ matrix.arch == 'x64' }}
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest \
            bash -lc '
            set -e
            export PATH="$PWD/flutter/bin:$PATH"
            git config --global --add safe.directory /workspace || true
            git config --global --add safe.directory /workspace/flutter || true
            flutter clean
            dart doc

            OWNER_UID=$(stat -c "%u" /workspace)
            OWNER_GID=$(stat -c "%g" /workspace)
            echo "Fixing ownership of doc/api to ${OWNER_UID}:${OWNER_GID}"
            chown -R ${OWNER_UID}:${OWNER_GID} /workspace/doc || true
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ${{ env.APP_NAME }}-linux-${{ matrix.arch }}-tar
          path: ${{ env.APP_NAME }}-linux-${{ matrix.arch }}.tar.gz

      - name: Fix permissions for doc directory
        if: ${{ matrix.arch == 'x64' }}
        run: |
          chmod -R 755 ./doc/api/
          ls -la ./doc/api/

      - name: ðŸ“‚ Sync files to domain
        if: ${{ matrix.arch == 'x64' }}
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ secrets.SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PW }}
          local-dir: "./doc/api/"
