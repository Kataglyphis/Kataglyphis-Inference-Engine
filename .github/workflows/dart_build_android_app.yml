# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Build + test + run android app

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

env:
  APP_NAME: kataglyphis-inference-engine-apk
  FLUTTER_VERSION: 3.41.0   # change here to update version for the whole workflow
  FLUTTER_DIR: /workspace/flutter  # Flutter SDK installation directory

jobs:
  build:
    strategy:
      matrix:
        include:
          - runs_on: ubuntu-24.04
            arch: x64
            platform: linux/amd64

    runs-on: ${{ matrix.runs_on }}
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Free Disk Space on Host
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: true

      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Login to GitHub Container Registry
        run: echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Pull container image
        run: bash scripts/linux/ci-dart-build-android-app.sh pull_container
        env:
          CONTAINER_IMAGE: ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest
          MATRIX_PLATFORM: ${{ matrix.platform }}
          MATRIX_ARCH: ${{ matrix.arch }}
          FLUTTER_VERSION: ${{ env.FLUTTER_VERSION }}
          FLUTTER_DIR: ${{ env.FLUTTER_DIR }}
          APP_NAME: ${{ env.APP_NAME }}

      - name: Setup Flutter in container
        run: bash scripts/linux/ci-dart-build-android-app.sh setup_flutter
        env:
          CONTAINER_IMAGE: ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest
          MATRIX_PLATFORM: ${{ matrix.platform }}
          MATRIX_ARCH: ${{ matrix.arch }}
          FLUTTER_VERSION: ${{ env.FLUTTER_VERSION }}
          FLUTTER_DIR: ${{ env.FLUTTER_DIR }}
          APP_NAME: ${{ env.APP_NAME }}

      - name: Run Flutter checks and tests
        run: bash scripts/linux/ci-dart-build-android-app.sh checks
        env:
          CONTAINER_IMAGE: ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest
          MATRIX_PLATFORM: ${{ matrix.platform }}
          MATRIX_ARCH: ${{ matrix.arch }}
          FLUTTER_VERSION: ${{ env.FLUTTER_VERSION }}
          FLUTTER_DIR: ${{ env.FLUTTER_DIR }}
          APP_NAME: ${{ env.APP_NAME }}

      - name: Build Flutter Android app
        run: bash scripts/linux/ci-dart-build-android-app.sh build_android
        env:
          CONTAINER_IMAGE: ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest
          MATRIX_PLATFORM: ${{ matrix.platform }}
          MATRIX_ARCH: ${{ matrix.arch }}
          FLUTTER_VERSION: ${{ env.FLUTTER_VERSION }}
          FLUTTER_DIR: ${{ env.FLUTTER_DIR }}
          APP_NAME: ${{ env.APP_NAME }}

      - name: Package build artifacts
        run: bash scripts/linux/ci-dart-build-android-app.sh package
        env:
          CONTAINER_IMAGE: ghcr.io/kataglyphis/kataglyphis_beschleuniger:latest
          MATRIX_PLATFORM: ${{ matrix.platform }}
          MATRIX_ARCH: ${{ matrix.arch }}
          FLUTTER_VERSION: ${{ env.FLUTTER_VERSION }}
          FLUTTER_DIR: ${{ env.FLUTTER_DIR }}
          APP_NAME: ${{ env.APP_NAME }}

      - name: Upload artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ${{ env.APP_NAME }}-linux-${{ matrix.arch }}-tar
          path: ${{ env.APP_NAME }}-linux-${{ matrix.arch }}.tar.gz

      # Upload SARIF to GitHub Code Scanning
      - name: Upload CodeQL results SARIF
        if: ${{ matrix.arch == 'x64' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: codeql-results
